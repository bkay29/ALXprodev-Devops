#!/usr/bin/env bash
# apiAutomation-0x00
# Objective: GET Pikachu data from the Pokémon API and save to data.json
# Requirements met:
# - fetch request to Pokémon API
# - error handling
# - save to data.json
# - log errors to errors.txt

set -o pipefail

API_URL="https://pokeapi.co/api/v2/pokemon/pikachu"
OUT_FILE="data.json"
ERR_FILE="errors.txt"
TMP_FILE="$(mktemp)"

# Make request (with a reasonable timeout)
# -s silent, -S show error, -f fail on HTTP >=400, --max-time 10 seconds
if curl -sS -f --max-time 10 "$API_URL" -o "$TMP_FILE"; then
  # Basic sanity check: ensure it's valid JSON-ish by checking first char
  first_char="$(head -c 1 "$TMP_FILE" 2>/dev/null || true)"
  if [[ "$first_char" != "{" && "$first_char" != "[" ]]; then
    echo "$(date --iso-8601=seconds) - Unexpected response format from $API_URL" >> "$ERR_FILE"
    rm -f "$TMP_FILE"
    exit 2
  fi

  # Move tmp to output (atomic-ish)
  mv "$TMP_FILE" "$OUT_FILE"
  # ensure correct permissions
  chmod 644 "$OUT_FILE"
  echo "$(date --iso-8601=seconds) - Successfully fetched $API_URL -> $OUT_FILE"
  exit 0
else
  # capture curl’s exit code and stderr output
  curl_exit=$?
  # Try to capture a short error message via a second curl attempt to stderr (non-silent)
  err_msg="$(curl --max-time 10 --fail "$API_URL" 2>&1 >/dev/null | tail -n 20)"
  echo "$(date --iso-8601=seconds) - ERROR fetching $API_URL (curl exit $curl_exit): $err_msg" >> "$ERR_FILE"
  rm -f "$TMP_FILE"
  exit 1
fi